---
# Alertmanager installation and configuration

- name: Create alertmanager group
  ansible.builtin.group:
    name: "{{ alertmanager_group }}"
    system: true
    state: present

- name: Create alertmanager user
  ansible.builtin.user:
    name: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    system: true
    shell: /usr/sbin/nologin
    home: "{{ alertmanager_data_dir }}"
    create_home: false

- name: Create alertmanager directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    mode: '0755'
  loop:
    - "{{ alertmanager_install_dir }}"
    - "{{ alertmanager_config_dir }}"
    - "{{ alertmanager_data_dir }}"
    - "{{ alertmanager_config_dir }}/templates"

- name: Set architecture variable
  ansible.builtin.set_fact:
    alertmanager_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else ansible_architecture }}"

- name: Check if alertmanager binary exists
  ansible.builtin.stat:
    path: "{{ alertmanager_install_dir }}/alertmanager"
  register: alertmanager_binary

- name: Download alertmanager
  ansible.builtin.get_url:
    url: "https://github.com/prometheus/alertmanager/releases/download/v{{ alertmanager_version }}/alertmanager-{{ alertmanager_version }}.linux-{{ alertmanager_arch }}.tar.gz"
    dest: "/tmp/alertmanager-{{ alertmanager_version }}.tar.gz"
    mode: '0644'
  register: alertmanager_download
  retries: 3
  delay: 5
  until: alertmanager_download is succeeded
  when: not alertmanager_binary.stat.exists

- name: Extract alertmanager archive
  ansible.builtin.unarchive:
    src: "/tmp/alertmanager-{{ alertmanager_version }}.tar.gz"
    dest: "/tmp"
    remote_src: true
    creates: "/tmp/alertmanager-{{ alertmanager_version }}.linux-{{ alertmanager_arch }}/alertmanager"
  when: not alertmanager_binary.stat.exists

- name: Copy alertmanager binaries
  ansible.builtin.copy:
    src: "/tmp/alertmanager-{{ alertmanager_version }}.linux-{{ alertmanager_arch }}/{{ item }}"
    dest: "{{ alertmanager_install_dir }}/{{ item }}"
    owner: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    mode: '0755'
    remote_src: true
  loop:
    - alertmanager
    - amtool
  notify: Restart alertmanager
  when: not alertmanager_binary.stat.exists

- name: Create symlinks for alertmanager binaries
  ansible.builtin.file:
    src: "{{ alertmanager_install_dir }}/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    state: link
  loop:
    - alertmanager
    - amtool

- name: Create alertmanager configuration
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ alertmanager_config_dir }}/alertmanager.yml"
    owner: "{{ alertmanager_user }}"
    group: "{{ alertmanager_group }}"
    mode: '0640'
  notify: Restart alertmanager

- name: Create alertmanager systemd service
  ansible.builtin.template:
    src: alertmanager.service.j2
    dest: /etc/systemd/system/alertmanager.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart alertmanager

- name: Start and enable alertmanager
  ansible.builtin.systemd:
    name: alertmanager
    state: "{{ alertmanager_service_state }}"
    enabled: "{{ alertmanager_service_enabled }}"
    daemon_reload: true

- name: Clean up temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/alertmanager-{{ alertmanager_version }}.tar.gz"
    - "/tmp/alertmanager-{{ alertmanager_version }}.linux-{{ alertmanager_arch }}"
  changed_when: false
