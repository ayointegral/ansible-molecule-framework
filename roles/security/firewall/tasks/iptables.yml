---
# Iptables specific tasks

- name: Ensure iptables directories exist
  ansible.builtin.file:
    path: "{{ firewall_iptables_rules_file | dirname }}"
    state: directory
    mode: '0755'

- name: Flush existing rules (if starting fresh)
  ansible.builtin.iptables:
    flush: true
    chain: "{{ item }}"
  loop:
    - INPUT
    - FORWARD
    - OUTPUT
  when: firewall_flush_existing | default(false) | bool

- name: Set default INPUT policy
  ansible.builtin.iptables:
    chain: INPUT
    policy: "{{ 'DROP' if firewall_default_policy == 'deny' else 'ACCEPT' }}"

- name: Set default FORWARD policy
  ansible.builtin.iptables:
    chain: FORWARD
    policy: DROP

- name: Set default OUTPUT policy
  ansible.builtin.iptables:
    chain: OUTPUT
    policy: ACCEPT

- name: Allow loopback traffic
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
    comment: "Allow loopback"
  when: firewall_allow_loopback | bool

- name: Allow established and related connections
  ansible.builtin.iptables:
    chain: INPUT
    ctstate:
      - ESTABLISHED
      - RELATED
    jump: ACCEPT
    comment: "Allow established connections"
  when: firewall_allow_established | bool

- name: Allow ICMP (ping)
  ansible.builtin.iptables:
    chain: INPUT
    protocol: icmp
    icmp_type: echo-request
    jump: ACCEPT
    comment: "Allow ping"
  when: firewall_allow_icmp | bool

- name: Apply SSH rate limiting
  when: firewall_ssh_rate_limit | bool
  block:
    - name: Add SSH rate limit rule
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 22
        ctstate:
          - NEW
        limit: "{{ firewall_ssh_rate_limit_burst }}/{{ firewall_ssh_rate_limit_period }}sec"
        limit_burst: "{{ firewall_ssh_rate_limit_burst }}"
        jump: ACCEPT
        comment: "SSH rate limit"

- name: Open ports
  ansible.builtin.iptables:
    chain: INPUT
    protocol: "{{ item.protocol | default('tcp') }}"
    destination_port: "{{ item.port }}"
    jump: ACCEPT
    comment: "{{ item.comment | default('Allow port ' + item.port | string) }}"
  loop: "{{ firewall_open_ports }}"
  loop_control:
    label: "{{ item.port }}/{{ item.protocol | default('tcp') }}"
  when: not (firewall_ssh_rate_limit | bool and item.port == 22)

- name: Allow source IPs
  ansible.builtin.iptables:
    chain: INPUT
    source: "{{ item.0.ip }}"
    protocol: "{{ item.0.protocol | default('tcp') }}"
    destination_port: "{{ item.1 }}"
    jump: ACCEPT
    comment: "Allow {{ item.0.ip }} to port {{ item.1 }}"
  loop: "{{ firewall_allowed_sources | subelements('ports', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.ip }}:{{ item.1 }}"

- name: Block source IPs
  ansible.builtin.iptables:
    chain: INPUT
    source: "{{ item.ip }}"
    jump: DROP
    comment: "{{ item.comment | default('Block ' + item.ip) }}"
  loop: "{{ firewall_blocked_sources }}"
  loop_control:
    label: "{{ item.ip }}"

- name: Apply custom iptables rules
  ansible.builtin.iptables:
    chain: "{{ item.chain | default('INPUT') }}"
    protocol: "{{ item.protocol | default(omit) }}"
    source: "{{ item.source | default(omit) }}"
    destination: "{{ item.destination | default(omit) }}"
    destination_port: "{{ item.destination_port | default(omit) }}"
    source_port: "{{ item.source_port | default(omit) }}"
    in_interface: "{{ item.in_interface | default(omit) }}"
    out_interface: "{{ item.out_interface | default(omit) }}"
    jump: "{{ item.jump | default('ACCEPT') }}"
    comment: "{{ item.comment | default(omit) }}"
  loop: "{{ firewall_iptables_rules }}"
  loop_control:
    label: "{{ item.comment | default(item.chain | default('INPUT')) }}"

- name: Log dropped packets
  ansible.builtin.iptables:
    chain: INPUT
    jump: LOG
    log_prefix: "iptables-dropped: "
    log_level: warning
  when: firewall_log_dropped | bool

- name: Save iptables rules (Debian)
  ansible.builtin.shell: |
    iptables-save > {{ firewall_iptables_rules_file }}
  when:
    - firewall_persistent | bool
    - ansible_os_family == 'Debian'
  changed_when: true

- name: Save iptables rules (RedHat)
  ansible.builtin.command: service iptables save
  when:
    - firewall_persistent | bool
    - ansible_os_family == 'RedHat'
  changed_when: true

- name: Apply IPv6 rules
  when: firewall_ipv6_enabled | bool
  block:
    - name: Set default IPv6 INPUT policy
      ansible.builtin.iptables:
        chain: INPUT
        policy: "{{ 'DROP' if firewall_default_policy == 'deny' else 'ACCEPT' }}"
        ip_version: ipv6

    - name: Allow IPv6 loopback
      ansible.builtin.iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT
        ip_version: ipv6
      when: firewall_allow_loopback | bool

    - name: Allow IPv6 established connections
      ansible.builtin.iptables:
        chain: INPUT
        ctstate:
          - ESTABLISHED
          - RELATED
        jump: ACCEPT
        ip_version: ipv6
      when: firewall_allow_established | bool

    - name: Allow ICMPv6
      ansible.builtin.iptables:
        chain: INPUT
        protocol: ipv6-icmp
        jump: ACCEPT
        ip_version: ipv6
      when: firewall_allow_icmp | bool

    - name: Save ip6tables rules (Debian)
      ansible.builtin.shell: |
        ip6tables-save > {{ firewall_ip6tables_rules_file }}
      when:
        - firewall_persistent | bool
        - ansible_os_family == 'Debian'
      changed_when: true

- name: Enable iptables service
  ansible.builtin.systemd:
    name: "{{ firewall_services.iptables }}"
    state: started
    enabled: "{{ firewall_enabled }}"
  when: firewall_services.iptables is defined
