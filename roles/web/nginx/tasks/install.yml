---
# Nginx installation tasks

- name: Install prerequisites
  ansible.builtin.package:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
  when: nginx_use_official_repo

# Debian/Ubuntu official repo setup
- name: Add official nginx signing key (Debian/Ubuntu)
  ansible.builtin.apt_key:
    url: https://nginx.org/keys/nginx_signing.key
    state: present
  when:
    - nginx_use_official_repo
    - ansible_os_family == 'Debian'

- name: Add official nginx repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb https://nginx.org/packages/{{ ansible_distribution | lower }}/ {{ ansible_distribution_release }} nginx"
    state: present
    filename: nginx
  when:
    - nginx_use_official_repo
    - ansible_os_family == 'Debian'

# RHEL/CentOS official repo setup
- name: Add official nginx repository (RHEL/CentOS)
  ansible.builtin.yum_repository:
    name: nginx
    description: nginx official repository
    baseurl: "https://nginx.org/packages/{{ 'rhel' if ansible_distribution == 'RedHat' else 'centos' }}/{{ ansible_distribution_major_version }}/$basearch/"
    gpgcheck: true
    gpgkey: https://nginx.org/keys/nginx_signing.key
    enabled: true
  when:
    - nginx_use_official_repo
    - ansible_os_family == 'RedHat'

# Install nginx package
- name: Install nginx (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ nginx_package_name }}{% if nginx_version %}={{ nginx_version }}{% endif %}"
    state: "{{ 'present' if nginx_version else 'latest' }}"
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == 'Debian'
  notify: Restart nginx

- name: Install nginx (RHEL/CentOS)
  ansible.builtin.yum:
    name: "{{ nginx_package_name }}{% if nginx_version %}-{{ nginx_version }}{% endif %}"
    state: "{{ 'present' if nginx_version else 'latest' }}"
  when: ansible_os_family == 'RedHat'
  notify: Restart nginx

# Ensure required directories exist
- name: Ensure nginx directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - "{{ nginx_conf_dir }}"
    - "{{ nginx_vhost_dir }}"
    - "{{ nginx_vhost_enabled_dir }}"
    - "{{ nginx_conf_d_dir }}"
    - "{{ nginx_default_root }}"
    - /var/log/nginx

# Ensure sites-enabled directory exists (Debian-style)
- name: Check if sites-enabled pattern is used
  ansible.builtin.stat:
    path: "{{ nginx_vhost_enabled_dir }}"
  register: sites_enabled_dir

- name: Create sites-enabled directory if needed
  ansible.builtin.file:
    path: "{{ nginx_vhost_enabled_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: not sites_enabled_dir.stat.exists
