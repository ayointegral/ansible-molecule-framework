---
- name: Converge - Test AWS services with LocalStack
  hosts: aws-test-instance
  become: true
  gather_facts: true
  vars:
    localstack_endpoint: "http://localstack:4566"
  environment:
    AWS_ACCESS_KEY_ID: "test"
    AWS_SECRET_ACCESS_KEY: "test"
    AWS_DEFAULT_REGION: "us-east-1"
    AWS_ENDPOINT_URL: "{{ localstack_endpoint }}"

  tasks:
    # S3 Operations
    - name: Create S3 bucket
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} s3 mb s3://test-bucket
        aws --endpoint-url={{ localstack_endpoint }} s3 mb s3://logs-bucket
        echo "Created S3 buckets"
      register: s3_create

    - name: Upload file to S3
      ansible.builtin.shell: |
        echo "Hello from LocalStack" > /tmp/test.txt
        aws --endpoint-url={{ localstack_endpoint }} s3 cp /tmp/test.txt s3://test-bucket/test.txt
        echo "Uploaded test.txt"
      register: s3_upload

    # SQS Operations
    - name: Create SQS queues
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} sqs create-queue --queue-name test-queue
        aws --endpoint-url={{ localstack_endpoint }} sqs create-queue --queue-name dlq-queue
        echo "Created SQS queues"
      register: sqs_create

    - name: Send SQS message
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} sqs send-message \
          --queue-url {{ localstack_endpoint }}/000000000000/test-queue \
          --message-body '{"event": "test", "timestamp": "{{ ansible_date_time.iso8601 }}"}'
        echo "Sent message to queue"
      register: sqs_send

    # SNS Operations
    - name: Create SNS topic
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} sns create-topic --name test-topic
        aws --endpoint-url={{ localstack_endpoint }} sns create-topic --name alerts-topic
        echo "Created SNS topics"
      register: sns_create

    # DynamoDB Operations
    - name: Create DynamoDB table
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} dynamodb create-table \
          --table-name test-table \
          --attribute-definitions AttributeName=id,AttributeType=S \
          --key-schema AttributeName=id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST
        echo "Created DynamoDB table"
      register: dynamodb_create
      ignore_errors: true

    - name: Insert DynamoDB item
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} dynamodb put-item \
          --table-name test-table \
          --item '{"id": {"S": "item1"}, "name": {"S": "Test Item"}, "value": {"N": "100"}}'
        echo "Inserted DynamoDB item"
      register: dynamodb_insert

    # Secrets Manager
    - name: Create secret
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} secretsmanager create-secret \
          --name test-secret \
          --secret-string '{"username": "admin", "password": "secret123"}'
        echo "Created secret"
      register: secrets_create
      ignore_errors: true

    # SSM Parameter Store
    - name: Create SSM parameters
      ansible.builtin.shell: |
        aws --endpoint-url={{ localstack_endpoint }} ssm put-parameter \
          --name "/app/config/database_url" \
          --value "postgresql://localhost:5432/mydb" \
          --type String --overwrite
        aws --endpoint-url={{ localstack_endpoint }} ssm put-parameter \
          --name "/app/config/api_key" \
          --value "supersecretkey" \
          --type SecureString --overwrite
        echo "Created SSM parameters"
      register: ssm_create

    - name: Display results
      ansible.builtin.debug:
        msg:
          - "S3: {{ s3_create.stdout }}"
          - "SQS: {{ sqs_create.stdout }}"
          - "SNS: {{ sns_create.stdout }}"
          - "DynamoDB: {{ dynamodb_create.stdout | default('created') }}"
          - "Secrets: {{ secrets_create.stdout | default('created') }}"
          - "SSM: {{ ssm_create.stdout }}"
