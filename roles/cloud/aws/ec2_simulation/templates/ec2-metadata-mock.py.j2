#!/usr/bin/env python3
"""
EC2 Instance Metadata Service (IMDS) Mock Server
Simulates AWS EC2 metadata service for testing purposes.
"""

import http.server
import socketserver
import os
import json
from urllib.parse import urlparse

METADATA_DIR = "{{ ec2_metadata_service_dir }}"
PORT = {{ ec2_simulation_port }}

class IMDSHandler(http.server.SimpleHTTPRequestHandler):
    """Handler for EC2 Instance Metadata Service requests."""

    def translate_path(self, path):
        """Translate URL path to filesystem path."""
        # Remove leading slash and convert to path
        path = path.lstrip('/')
        return os.path.join(METADATA_DIR, path)

    def do_GET(self):
        """Handle GET requests."""
        path = self.translate_path(self.path)
        
        # Handle directory listing
        if os.path.isdir(path):
            try:
                entries = os.listdir(path)
                content = '\n'.join(entries)
                self.send_response(200)
                self.send_header('Content-Type', 'text/plain')
                self.send_header('Content-Length', len(content))
                self.end_headers()
                self.wfile.write(content.encode())
            except Exception as e:
                self.send_error(404, f"Not found: {str(e)}")
            return

        # Handle file content
        if os.path.isfile(path):
            try:
                with open(path, 'r') as f:
                    content = f.read()
                
                # Determine content type
                if path.endswith('.json'):
                    content_type = 'application/json'
                else:
                    content_type = 'text/plain'
                
                self.send_response(200)
                self.send_header('Content-Type', content_type)
                self.send_header('Content-Length', len(content))
                self.end_headers()
                self.wfile.write(content.encode())
            except Exception as e:
                self.send_error(500, f"Error reading file: {str(e)}")
            return

        self.send_error(404, "Not found")

    def do_PUT(self):
        """Handle PUT requests for IMDSv2 token."""
        if '/api/token' in self.path:
            # Simulate IMDSv2 token endpoint
            token = "AQAEAGMy9xxxxxxxxxxxxxxxxxxxxxxxMDExNg=="
            self.send_response(200)
            self.send_header('Content-Type', 'text/plain')
            self.send_header('Content-Length', len(token))
            self.end_headers()
            self.wfile.write(token.encode())
            return
        self.send_error(404, "Not found")

    def log_message(self, format, *args):
        """Suppress logging for cleaner output."""
        pass

def main():
    """Start the mock IMDS server."""
    with socketserver.TCPServer(("0.0.0.0", PORT), IMDSHandler) as httpd:
        print(f"EC2 Metadata Mock Server running on port {PORT}")
        print(f"Serving metadata from: {METADATA_DIR}")
        httpd.serve_forever()

if __name__ == "__main__":
    main()
