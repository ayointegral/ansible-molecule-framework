#!/usr/bin/env python3
"""
Azure Key Vault Mock Server
Simulates Azure Key Vault API for testing purposes.
"""

from flask import Flask, jsonify, request, abort
import os
import json
from datetime import datetime, timedelta

app = Flask(__name__)

VAULT_NAME = "{{ keyvault_name }}"
DATA_DIR = "{{ keyvault_data_dir }}"
PORT = {{ keyvault_port }}

def get_secret(name):
    """Read a secret from disk."""
    path = os.path.join(DATA_DIR, "secrets", name)
    if os.path.exists(path):
        with open(path, 'r') as f:
            return f.read()
    return None

def set_secret(name, value):
    """Write a secret to disk."""
    path = os.path.join(DATA_DIR, "secrets", name)
    with open(path, 'w') as f:
        f.write(value)
    return True

def list_secrets():
    """List all secrets."""
    secrets_dir = os.path.join(DATA_DIR, "secrets")
    if os.path.exists(secrets_dir):
        return os.listdir(secrets_dir)
    return []

@app.route('/secrets/<name>', methods=['GET'])
def get_secret_endpoint(name):
    """Get a secret by name."""
    version = request.args.get('api-version', '7.4')
    value = get_secret(name)
    if value is None:
        abort(404, description=f"Secret {name} not found")
    
    return jsonify({
        "value": value,
        "id": f"https://{VAULT_NAME}.vault.azure.net/secrets/{name}",
        "attributes": {
            "enabled": True,
            "created": int(datetime.now().timestamp()),
            "updated": int(datetime.now().timestamp())
        }
    })

@app.route('/secrets/<name>', methods=['PUT'])
def set_secret_endpoint(name):
    """Set a secret."""
    version = request.args.get('api-version', '7.4')
    data = request.get_json()
    
    if 'value' not in data:
        abort(400, description="Missing 'value' in request body")
    
    set_secret(name, data['value'])
    
    return jsonify({
        "value": data['value'],
        "id": f"https://{VAULT_NAME}.vault.azure.net/secrets/{name}",
        "attributes": {
            "enabled": True,
            "created": int(datetime.now().timestamp()),
            "updated": int(datetime.now().timestamp())
        }
    }), 201

@app.route('/secrets', methods=['GET'])
def list_secrets_endpoint():
    """List all secrets."""
    version = request.args.get('api-version', '7.4')
    secrets = list_secrets()
    
    return jsonify({
        "value": [
            {
                "id": f"https://{VAULT_NAME}.vault.azure.net/secrets/{s}",
                "attributes": {
                    "enabled": True
                }
            }
            for s in secrets
        ]
    })

@app.route('/health', methods=['GET'])
def health():
    """Health check endpoint."""
    return jsonify({"status": "healthy", "vault": VAULT_NAME})

if __name__ == '__main__':
    print(f"Azure Key Vault Mock Server running on port {PORT}")
    print(f"Vault name: {VAULT_NAME}")
    app.run(host='{{ keyvault_bind_address }}', port=PORT, debug=False)
