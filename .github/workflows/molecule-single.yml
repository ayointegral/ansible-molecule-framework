---
# Manual workflow to test a single role
name: Molecule Single Role

on:
  workflow_dispatch:
    inputs:
      role:
        description: 'Role path (e.g., common/base, services/nginx)'
        required: true
        type: string
      platform:
        description: 'Platform to test on'
        required: true
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - debian
          - rocky
          - all
      debug:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  validate:
    name: Validate Input
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.validate.outputs.platforms }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate role exists
        id: validate
        run: |
          ROLE_PATH="roles/${{ inputs.role }}"
          
          if [ ! -d "$ROLE_PATH" ]; then
            echo "❌ Role not found: ${{ inputs.role }}" >> $GITHUB_STEP_SUMMARY
            echo "Available roles:" >> $GITHUB_STEP_SUMMARY
            find roles -type d -name "default" -path "*/molecule/*" \
              | sed 's|roles/||; s|/molecule/default||' \
              | sort \
              | while read role; do echo "- \`$role\`" >> $GITHUB_STEP_SUMMARY; done
            exit 1
          fi
          
          if [ ! -d "$ROLE_PATH/molecule/default" ]; then
            echo "❌ No molecule scenario found in ${{ inputs.role }}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Determine platforms
          if [ "${{ inputs.platform }}" == "all" ]; then
            echo 'platforms=["ubuntu", "debian", "rocky"]' >> $GITHUB_OUTPUT
          else
            echo 'platforms=["${{ inputs.platform }}"]' >> $GITHUB_OUTPUT
          fi
          
          echo "✅ Validated: Testing \`${{ inputs.role }}\` on ${{ inputs.platform }}" >> $GITHUB_STEP_SUMMARY

  test:
    name: Test ${{ matrix.platform }}
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.validate.outputs.platforms) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Configure platform
        id: config
        run: |
          case "${{ matrix.platform }}" in
            ubuntu)
              echo "image=geerlingguy/docker-ubuntu2204-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            debian)
              echo "image=geerlingguy/docker-debian12-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            rocky)
              echo "image=geerlingguy/docker-rockylinux9-ansible:latest" >> $GITHUB_OUTPUT
              ;;
          esac
          
          INSTANCE=$(echo "${{ inputs.role }}-${{ matrix.platform }}" | tr '/' '-')
          echo "instance=${INSTANCE}" >> $GITHUB_OUTPUT

      - name: Create CI molecule scenario
        run: |
          ROLE_DIR="roles/${{ inputs.role }}"
          INSTANCE="${{ steps.config.outputs.instance }}"
          IMAGE="${{ steps.config.outputs.image }}"
          
          mkdir -p "$ROLE_DIR/molecule/ci"
          
          cat > "$ROLE_DIR/molecule/ci/molecule.yml" << EOF
          ---
          driver:
            name: docker
          platforms:
            - name: ${INSTANCE}
              image: ${IMAGE}
              pre_build_image: true
              privileged: true
              cgroupns_mode: host
              volumes:
                - /sys/fs/cgroup:/sys/fs/cgroup:rw
              tmpfs:
                - /run
                - /tmp
              command: ""
          provisioner:
            name: ansible
            env:
              ANSIBLE_ALLOW_BROKEN_CONDITIONALS: "true"
            playbooks:
              converge: ../default/converge.yml
              verify: ../default/verify.yml
          verifier:
            name: ansible
          EOF

      - name: Run Molecule test
        id: molecule
        working-directory: roles/${{ inputs.role }}
        run: |
          START=$(date +%s)
          
          DEBUG_FLAG=""
          if [ "${{ inputs.debug }}" == "true" ]; then
            DEBUG_FLAG="--debug"
          fi
          
          if molecule $DEBUG_FLAG test -s ci 2>&1 | tee molecule.log; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi
          
          END=$(date +%s)
          echo "duration=$((END - START))s" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-log-${{ inputs.role }}-${{ matrix.platform }}
          path: roles/${{ inputs.role }}/molecule.log
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Result: ${{ inputs.role }} on ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.molecule.outputs.result }}" == "passed" ]; then
            echo "✅ **PASSED** in ${{ steps.molecule.outputs.duration }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Last 50 lines of log:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 roles/${{ inputs.role }}/molecule.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set job result
        if: steps.molecule.outputs.result == 'failed'
        run: exit 1

  result:
    name: Final Result
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: always()
    steps:
      - name: Report
        run: |
          echo "# Single Role Test Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Role:** \`${{ inputs.role }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform(s):** ${{ inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Debug:** ${{ inputs.debug }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
