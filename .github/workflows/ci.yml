---
# Main CI workflow - runs on push and PR
name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'roles/**'
      - 'inventories/**'
      - 'playbooks/**'
      - '.github/workflows/**'
      - 'requirements.txt'
      - 'requirements.yml'
  pull_request:
    branches: [main]
    paths:
      - 'roles/**'
      - 'inventories/**'
      - 'playbooks/**'
      - '.github/workflows/**'
      - 'requirements.txt'
      - 'requirements.yml'
  workflow_dispatch:

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  # Discover all roles with molecule tests
  discover:
    name: Discover Roles
    runs-on: ubuntu-latest
    outputs:
      roles: ${{ steps.find.outputs.roles }}
      role_count: ${{ steps.find.outputs.role_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find roles with molecule tests
        id: find
        run: |
          # Find all roles with molecule/default directories, excluding Windows roles
          ROLES=$(find roles -type d -name "default" -path "*/molecule/*" \
            | sed 's|roles/||; s|/molecule/default||' \
            | grep -v "^windows/" \
            | sort \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "roles=${ROLES}" >> $GITHUB_OUTPUT
          echo "role_count=$(echo $ROLES | jq '. | length')" >> $GITHUB_OUTPUT

          echo "## Discovered Roles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found $(echo $ROLES | jq '. | length') roles with molecule tests:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ROLES" | jq -r '.[]' | while read role; do
            echo "- \`$role\`" >> $GITHUB_STEP_SUMMARY
          done

  # Lint check (non-blocking)
  lint:
    name: Lint
    uses: ./.github/workflows/_lint.yml

  # Syntax check for all playbooks
  syntax:
    name: Syntax Check
    runs-on: ubuntu-latest
    needs: discover
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Syntax check playbooks
        run: |
          echo "## Syntax Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          # Find all playbooks in subdirectories
          for playbook in $(find playbooks -name "*.yml" -type f | sort); do
            # Skip site.yml as it uses import_playbook which requires special handling
            if [[ "$playbook" == *"site.yml" ]]; then
              echo "â­ï¸ \`$playbook\` (skipped - uses import_playbook)" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            if ansible-playbook --syntax-check "$playbook" -i inventories/test/test-web/hosts.yml 2>&1; then
              echo "âœ… \`$playbook\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ \`$playbook\`" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done

          exit $FAILED

  # Run molecule tests on standard roles (no sidecars needed)
  molecule-quick:
    name: Molecule Quick
    runs-on: ubuntu-latest
    needs: [discover, syntax]
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        role:
          # Common roles
          - common/base
          - common/packages
          - common/users
          # Container roles
          - containers/docker
          - containers/podman
          # Database roles
          - databases/mysql
          - databases/postgresql
          - databases/redis
          # Monitoring roles
          - monitoring/alertmanager
          - monitoring/grafana
          - monitoring/node_exporter
          - monitoring/prometheus
          # Security roles
          - security/certificates
          - security/firewall
          - security/hardening
          - security/selinux
          # Storage roles
          - storage/disk_management
          - storage/lvm
          - storage/nfs
          # Web roles
          - web/haproxy
          - web/nginx
        platform: [ubuntu]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Configure platform
        id: config
        run: |
          case "${{ matrix.platform }}" in
            ubuntu)
              echo "image=geerlingguy/docker-ubuntu2204-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            debian)
              echo "image=geerlingguy/docker-debian12-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            rocky)
              echo "image=geerlingguy/docker-rockylinux9-ansible:latest" >> $GITHUB_OUTPUT
              ;;
          esac

          INSTANCE=$(echo "${{ matrix.role }}-${{ matrix.platform }}" | tr '/' '-')
          echo "instance=${INSTANCE}" >> $GITHUB_OUTPUT

      - name: Create CI molecule scenario
        run: |
          ROLE_DIR="roles/${{ matrix.role }}"
          INSTANCE="${{ steps.config.outputs.instance }}"
          IMAGE="${{ steps.config.outputs.image }}"

          mkdir -p "$ROLE_DIR/molecule/ci"

          cat > "$ROLE_DIR/molecule/ci/molecule.yml" << EOF
          ---
          driver:
            name: docker
          platforms:
            - name: ${INSTANCE}
              image: ${IMAGE}
              pre_build_image: true
              privileged: true
              cgroupns_mode: host
              volumes:
                - /sys/fs/cgroup:/sys/fs/cgroup:rw
              tmpfs:
                - /run
                - /tmp
              command: ""
          provisioner:
            name: ansible
            env:
              ANSIBLE_ALLOW_BROKEN_CONDITIONALS: "true"
            playbooks:
              converge: ../default/converge.yml
              verify: ../default/verify.yml
          verifier:
            name: ansible
          EOF

      - name: Run Molecule test
        id: molecule
        working-directory: roles/${{ matrix.role }}
        run: |
          START=$(date +%s)

          if molecule test -s ci 2>&1 | tee molecule.log; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

          END=$(date +%s)
          echo "duration=$((END - START))s" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-log-${{ steps.config.outputs.instance }}
          path: roles/${{ matrix.role }}/molecule.log
          retention-days: 5

      - name: Set job result
        if: steps.molecule.outputs.result == 'failed'
        run: exit 1

  # Run molecule tests on cloud roles (require sidecar emulators)
  molecule-cloud:
    name: Molecule Cloud
    runs-on: ubuntu-latest
    needs: [discover, syntax]
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          # AWS with LocalStack
          - role: cloud/aws/localstack
            scenario: default
          - role: cloud/aws/s3
            scenario: default
          - role: cloud/aws/ec2_simulation
            scenario: default
          # Azure with Azurite
          - role: cloud/azure/storage_account
            scenario: default
          - role: cloud/azure/keyvault
            scenario: default
          # GCP with emulators
          - role: cloud/gcp/gcs
            scenario: default
          - role: cloud/gcp/pubsub
            scenario: default
          # HashiCorp tools
          - role: cloud/vault
            scenario: default
          - role: cloud/consul
            scenario: default

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Configure instance name
        id: config
        run: |
          INSTANCE=$(echo "${{ matrix.role }}" | tr '/' '-')
          echo "instance=${INSTANCE}" >> $GITHUB_OUTPUT

      - name: Run Molecule test
        id: molecule
        working-directory: roles/${{ matrix.role }}
        run: |
          START=$(date +%s)

          if molecule test -s ${{ matrix.scenario }} 2>&1 | tee molecule.log; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

          END=$(date +%s)
          echo "duration=$((END - START))s" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-log-cloud-${{ steps.config.outputs.instance }}
          path: roles/${{ matrix.role }}/molecule.log
          retention-days: 5

      - name: Set job result
        if: steps.molecule.outputs.result == 'failed'
        run: exit 1

  # Summary job
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [discover, lint, syntax, molecule-quick, molecule-cloud]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Discover
          if [ "${{ needs.discover.result }}" == "success" ]; then
            echo "| ðŸ” Discover | âœ… Found ${{ needs.discover.outputs.role_count }} roles |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Discover | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Lint
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| ðŸ“ Lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“ Lint | âš ï¸ Issues found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Syntax
          if [ "${{ needs.syntax.result }}" == "success" ]; then
            echo "| ðŸ”§ Syntax | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”§ Syntax | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Molecule Quick
          if [ "${{ needs.molecule-quick.result }}" == "success" ]; then
            echo "| ðŸ§ª Molecule Quick | âœ… Passed (21 roles) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Molecule Quick | âŒ Some tests failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Molecule Cloud
          if [ "${{ needs.molecule-cloud.result }}" == "success" ]; then
            echo "| â˜ï¸ Molecule Cloud | âœ… Passed (9 roles) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â˜ï¸ Molecule Cloud | âŒ Some tests failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 30 roles tested** (excludes 3 Windows roles requiring Windows host)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*For full matrix testing across all platforms, run the 'Molecule Full Matrix' workflow manually.*" >> $GITHUB_STEP_SUMMARY

      - name: Check overall result
        run: |
          if [ "${{ needs.syntax.result }}" != "success" ]; then
            echo "Syntax check failed"
            exit 1
          fi
          if [ "${{ needs.molecule-quick.result }}" != "success" ]; then
            echo "Molecule quick tests failed"
            exit 1
          fi
          if [ "${{ needs.molecule-cloud.result }}" != "success" ]; then
            echo "Molecule cloud tests failed"
            exit 1
          fi
          echo "All critical checks passed!"
