---
# Full matrix testing - all roles x all platforms
name: Molecule Full Matrix

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform filter (all, ubuntu, debian, rocky)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu
          - debian
          - rocky
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  PY_COLORS: '1'
  ANSIBLE_FORCE_COLOR: '1'

jobs:
  # Discover all roles
  discover:
    name: Discover Roles
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      role_count: ${{ steps.matrix.outputs.role_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build test matrix
        id: matrix
        run: |
          # Find all roles with molecule tests, excluding Windows
          ROLES=$(find roles -type d -name "default" -path "*/molecule/*" \
            | sed 's|roles/||; s|/molecule/default||' \
            | grep -v "^windows/" \
            | sort)
          
          # Determine platforms based on input
          PLATFORM_INPUT="${{ inputs.platform }}"
          if [ -z "$PLATFORM_INPUT" ] || [ "$PLATFORM_INPUT" == "all" ]; then
            PLATFORMS="ubuntu debian rocky"
          else
            PLATFORMS="$PLATFORM_INPUT"
          fi
          
          # Build matrix JSON
          MATRIX='{"include":['
          FIRST=true
          
          for role in $ROLES; do
            for platform in $PLATFORMS; do
              # Skip known incompatible combinations
              if [[ "$role" == "cloud/azure/"* ]] && [ "$platform" == "rocky" ]; then
                continue
              fi
              
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX="$MATRIX,"
              fi
              MATRIX="$MATRIX{\"role\":\"$role\",\"platform\":\"$platform\"}"
            done
          done
          
          MATRIX="$MATRIX]}"
          
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT
          echo "role_count=$(echo $ROLES | wc -w | tr -d ' ')" >> $GITHUB_OUTPUT
          
          echo "## Test Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Testing ${{ inputs.platform || 'all' }} platform(s) across $(echo $ROLES | wc -w | tr -d ' ') roles" >> $GITHUB_STEP_SUMMARY

  # Run molecule tests
  molecule:
    name: Test
    runs-on: ubuntu-latest
    needs: discover
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml

      - name: Configure platform
        id: config
        run: |
          case "${{ matrix.platform }}" in
            ubuntu)
              echo "image=geerlingguy/docker-ubuntu2204-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            debian)
              echo "image=geerlingguy/docker-debian12-ansible:latest" >> $GITHUB_OUTPUT
              ;;
            rocky)
              echo "image=geerlingguy/docker-rockylinux9-ansible:latest" >> $GITHUB_OUTPUT
              ;;
          esac
          
          INSTANCE=$(echo "${{ matrix.role }}-${{ matrix.platform }}" | tr '/' '-')
          echo "instance=${INSTANCE}" >> $GITHUB_OUTPUT

      - name: Create CI molecule scenario
        run: |
          ROLE_DIR="roles/${{ matrix.role }}"
          INSTANCE="${{ steps.config.outputs.instance }}"
          IMAGE="${{ steps.config.outputs.image }}"
          
          mkdir -p "$ROLE_DIR/molecule/ci"
          
          cat > "$ROLE_DIR/molecule/ci/molecule.yml" << EOF
          ---
          driver:
            name: docker
          platforms:
            - name: ${INSTANCE}
              image: ${IMAGE}
              pre_build_image: true
              privileged: true
              cgroupns_mode: host
              volumes:
                - /sys/fs/cgroup:/sys/fs/cgroup:rw
              tmpfs:
                - /run
                - /tmp
              command: ""
          provisioner:
            name: ansible
            env:
              ANSIBLE_ALLOW_BROKEN_CONDITIONALS: "true"
            playbooks:
              converge: ../default/converge.yml
              verify: ../default/verify.yml
          verifier:
            name: ansible
          EOF

      - name: Run Molecule test
        id: molecule
        working-directory: roles/${{ matrix.role }}
        run: |
          START=$(date +%s)
          
          if molecule test -s ci 2>&1 | tee molecule.log; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi
          
          END=$(date +%s)
          echo "duration=$((END - START))s" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-log-${{ matrix.role }}-${{ matrix.platform }}
          path: roles/${{ matrix.role }}/molecule.log
          retention-days: 5

      - name: Report result
        if: always()
        run: |
          ROLE="${{ matrix.role }}"
          PLATFORM="${{ matrix.platform }}"
          RESULT="${{ steps.molecule.outputs.result }}"
          DURATION="${{ steps.molecule.outputs.duration }}"
          
          if [ "$RESULT" == "passed" ]; then
            echo "âœ… **${ROLE}** on ${PLATFORM} - ${DURATION}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **${ROLE}** on ${PLATFORM} - FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set job result
        if: steps.molecule.outputs.result == 'failed'
        run: exit 1

  # Generate final summary
  summary:
    name: Results Summary
    runs-on: ubuntu-latest
    needs: [discover, molecule]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: logs
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Molecule Full Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Roles tested:** ${{ needs.discover.outputs.role_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform(s):** ${{ inputs.platform || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Overall result:** ${{ needs.molecule.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.molecule.result }}" == "success" ]; then
            echo "ðŸŽ‰ **All molecule tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some molecule tests failed.** Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download test logs from the Artifacts section below." >> $GITHUB_STEP_SUMMARY
